<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css"
      rel="stylesheet"
      integrity="sha384-GLhlTQ8iRABdZLl6O3oVMWSktQOp6b7In1Zl3/Jr59b6EGGoI1aFkw7cmDA6j6gD"
      crossorigin="anonymous"
    />
    <title>Road works</title>
  </head>
  <body>
       <div class="container">
      <style type="text/css" scoped>
        /* Tabs - increased accessibility */
        .nav-tabs .nav-item.show .nav-link,
        .nav-tabs .nav-link.active {
          color: #212529;
          border-color: #4b5458 #4b5458 #fff;
          margin-bottom: 0;
        }

        .nav-tabs .nav-link {
          border: 2px solid transparent;
        }

        .nav-tabs {
          border-bottom: 2px solid #4b5458;
        }

        .nav-link {
          color: #0248b1;
        }

        /* search input */
        #contentTypeSearchBtn,
        #contentTypeSearchInput {
          border: 2px solid #4b5458;
        }

        /* Pagination */
        .page-item.disabled .page-link {
          color: #555c62;
          border: 2px solid #4b5458;
        }

        .page-link {
          color: #0248b1;
          border: 2px solid #4b5458;
          margin: 0 22px 22px 0;
        }

        .date .page-link {
          color: #0248b1;
          border: 2px solid #4b5458;
          margin: 0;
        }

        .page-item button {
          min-width: 3em;
        }

        table {
          width: 100%;
        }

        .arrows {
          max-width: 1rem;
        }

        ul {
          padding-left: 0.5rem;
        }

        button {
          color: Black;
        }

        .black {
          color: Black !important;
        }

        .entryUpIcon {
          position: relative;
          top: -0.5rem;
        }

        .entryDownIcon {
          position: relative;
          top: 0.35rem;
          right: 1rem;
        }

        #upstartDate {
          color: Black;
        }

        #description {
          width: 25% !important;
        }

        td {
          width: 7rem;
          vertical-align: top;
          padding-top: 0.5rem;
        }

        @supports (-webkit-appearance: none) {
          .entryUpIcon {
            top: -0.4rem;
          }

          .entryDownIcon {
            bottom: -0.3rem;
            right: 1rem;
          }
        }

        @supports (-moz-appearance: none) {
          .entryUpIcon {
            top: -0.6rem;
          }

          .entryDownIcon {
            bottom: -0.3rem;
            right: 0.77rem;
          }
        }
      </style>
      <div class="mt-3" id="app">
        <div>
          <ul id="myTab" class="nav nav-tabs" role="tablist">
            <li class="nav-item" role="presentation">
              <button
                id="table-tab"
                class="nav-link active"
                role="tab"
                aria-controls="table"
                aria-selected="true"
                type="button"
                data-bs-toggle="tab"
                data-bs-target="#table"
                @click="toggleTabs"
              >
                Table
              </button>
            </li>
            <li class="nav-item" role="presentation">
              <button
                id="map-tab"
                class="nav-link"
                role="tab"
                aria-controls="contact"
                aria-selected="false"
                type="button"
                data-bs-toggle="tab"
                data-bs-target="#map"
                @click="toggleTabs"
              >
                Map
              </button>
            </li>
          </ul>
          <div id="myTabContent" class="tab-content">
            <div v-if="error">
              <p>Nothing to display at present. Try again in a few minutes.</p>
            </div>
            <div
              id="table"
              class="mt-3 tab-pane fade show active"
              role="tabpanel"
              aria-labelledby="table-tab"
            >
              <div v-if="table">
                <div class="text-center" v-if="loading">
                  <span class="spinner-border"></span>
                </div>
                <div v-else>
                  <div v-if="!error">
                    <p>
                      This information was last updated on {{date}} at {{time}}.
                    </p>

                    <div class="search-options-container">
                      <div class="row">
                        <div class="input-group mb-3 content-type-search">
                          <input
                            @input="search"
                            autocomplete="off"
                            type="text"
                            class="form-control"
                            placeholder="Type here to filter results"
                            v-model="searchTerm"
                            aria-label="Search term"
                            id="contentTypeSearchInput"
                          />
                          <label for="contentTypeSearchInput" class="hidden"
                            >Search term</label
                          >
                          <div class="input-group-append">
                            <button
                              v-if="searchTerm.length > 0"
                              class="ms-2 btn btn-outline-secondary"
                              type="button"
                              v-on:click="resetSearch"
                            >
                              Clear Search
                            </button>
                          </div>
                        </div>
                      </div>

                      <div class="row mb-3 date">
                        <h2 class="fs-5">Filter by date</h2>
                        <div class="col-auto">
                          <h3 class="fs-6">Start</h3>
                          <input v-model="dateStart" type="date" />
                        </div>

                        <div class="col-auto">
                          <h3 class="fs-6">End</h3>
                          <input v-model="dateEnd" type="date" />
                        </div>
                        <div class="col-auto align-self-end">
                          <button
                            @click="filter"
                            class="page-link rounded"
                            type="button"
                          >
                            Filter
                          </button>
                        </div>
                        <div class="col-auto align-self-end">
                          <button
                            @click="reset"
                            class="page-link rounded"
                            type="button"
                          >
                            Reset
                          </button>
                        </div>
                      </div>
                      <nav
                        v-if="pageCount > 1"
                        role="navigation"
                        aria-label="Results data navigation"
                      >
                        <ul class="pagination d-flex flex-wrap mb-2 ms-0">
                          <li
                            class="page-item"
                            v-bind:class="{disabled: pageIndex===0}"
                          >
                            <button
                              class="page-link rounded"
                              type="button"
                              v-on:click="goToPage(pageIndex - 1)"
                            >
                              Previous
                            </button>
                          </li>

                          <li
                            class="page-item"
                            v-bind:class="{disabled: pageIndex + 1 >=pageCount}"
                          >
                            <button
                              class="page-link rounded"
                              type="button"
                              v-on:click="goToPage(pageIndex + 1)"
                            >
                              Next
                            </button>
                          </li>
                        </ul>
                      </nav>
                      <div class="api-results-info">
                        <p>Total results: <strong>{{totalCount }}</strong></p>
                        <p v-if="pageCount > 1">
                          Page {{pageIndex + 1}} of {{pageCount}}
                        </p>
                      </div>
                      <p>Clicking on a location will display a map.</p>
                      <div class="table-responsive">
                        <table class="usr_TableDefault">
                          <caption class="d-none">
                            Roadworks
                          </caption>
                          <thead>
                            <tr>
                              <th
                                v-for="obj in fields"
                                tabindex="0"
                                scope="col"
                                @click="sortByField(obj)"
                                class="tableHead p-0 align-middle"
                                :id="obj.id"
                              >
                                <div class="row g-0">
                                  <div class="arrows col-1 p-0">
                                    <span
                                      class="entryUpIcon"
                                      :id="`up${obj.id}`"
                                      >&#9650;</span
                                    >
                                    <span
                                      class="entryDownIcon"
                                      :id="`down${obj.id}`"
                                      >&#9660;</span
                                    >
                                  </div>
                                  <div class="col-11 pt-1 ps-2">
                                    {{obj.display}}
                                  </div>
                                </div>
                              </th>
                            </tr>
                          </thead>
                          <tbody>
                            <tr v-for="item in items">
                              <td>
                                <span @click="showMap(item)">
                                  <ul class="my-0">
                                    <template
                                      v-for="l in item.locations.split('^#')"
                                    >
                                      <li v-if="l !== 'None'">
                                        <span class="fakeLink">{{l}}</span>
                                      </li>
                                    </template>
                                  </ul>
                                </span>
                                <p
                                  class="mt-2 mb-0 ps-1"
                                  :class="{'text-danger':  item.severity === 'High'}"
                                >
                                  Impact: {{item.severity}}
                                </p>
                              </td>
                              <td>
                                <ul>
                                  <li v-for="v in item.description.split('^#')">
                                    <span v-if="v.length">{{v}}</span>
                                    <span v-else
                                      >View map for more details</span
                                    >
                                  </li>
                                  <li v-if="item.extra">{{item.extra}}</li>
                                </ul>
                              </td>
                              <td>{{formatDate(item.startDate)}}</td>
                              <td>{{formatDate(item.endDate)}}</td>
                              <td>{{item.responsible}}</td>
                            </tr>
                          </tbody>
                        </table>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
              <div v-if="!table" class="loc-map">
                <button class="cec-button" type="button" @click="showTable">
                  Back to table
                </button>
                <div
                  title="One Networkd"
                  class="ElginRoadworksWidget"
                  :id="mapId"
                  style="width: 100%; height: 800px"
                >
                  <iframe
                    style="width: 100%; height: 800px; border: medium"
                    :src="mapUrl"
                  ></iframe>
                </div>
              </div>
            </div>
            <div
              id="map"
              class="mt-3 tab-pane fade"
              role="tabpanel"
              aria-labelledby="map-tab"
            >
              <p>
                You can view current and upcoming
                <strong>planned</strong> roadworks, road closures and other
                traffic disruptions in Cheshire East on the&nbsp;<a
                  style="font-size: 1em"
                  title="One Network (external link) "
                  href="https://one.network/custom/cheshireeast/"
                  >One Network</a
                >&nbsp;website.
              </p>
              <p>
                You can search by street name and view any planned roadworks
                within the next 12 months.
              </p>
              <p>Zoom into the map to see the detail.</p>
              <p>
                You can register for an account to set up email alerts for a
                specific area.&nbsp;
              </p>
              <p>
                Click on &lsquo;data layers&rsquo; to change filters for
                information such as live traffic, road closures and diversions.
                You can see&nbsp;roadworks planned for a future date
                by&nbsp;selecting up to twelve months ahead using the options
                box on the map.&nbsp;
              </p>
              <div v-if="showMainMap">
                <div
                  title="One Networkd"
                  id="erw-container2"
                  class="ElginRoadworksWidget"
                  style="width: 100%; height: 800px"
                ></div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script>
      const __ElginLoaderRetroFit = function (opts) {
        const container = document.getElementById('erw-container2');
        if (container) {
          const baseUrl =
              'https://portal-gb.one.network/prd-portal-one-network/embed/?src=rw.org&options=',
            iframe = document.createElement('iframe');
          iframe.style.width = '100%';
          iframe.style.height = '100%';
          iframe.style.border = 'none';
          iframe.src = baseUrl + encodeURIComponent(JSON.stringify(opts));
          container.innerHTML = '';
          container.appendChild(iframe);
        }
      };

      const OPTS = {
        googleAPIKey: 'AIzaSyDG00gQi_7ApZ54lG6mOu6ov-fNLl7lpOg',
        organisationID: 1451,
        embedded: true,
        data: {
          layersActive: [
            'INCIDENTS_LIVE_INCIDENT',
            'INCIDENTS_LIVE_ACCIDENT',
            'INCIDENTS_LIVE_WEATHER',
            'INCIDENTS_LIVE_LANDSLIP',
            'INCIDENTS_LIVE_FLOOD',
            'INCIDENTS_LIVE_ROADCLOSURE',
            'INCIDENTS_LIVE_LANECLOSURE',
            'INCIDENTS_LIVE_HGVCLOSURE',
            'TM_LAYER_ROADCLOSURE_LIVE',
            'TM_LAYER_DIVERSIONROUTE_LIVE',
            'TM_LAYER_HGVDIVERSIONROUTE_LIVE',
            'TM_LAYER_TEMPORARYONEWAY_LIVE',
            'TM_LAYER_BRIDGECLOSURE_LIVE',
            'TM_LAYER_LANECLOSURE_LIVE',
            'TM_LAYER_FOOTWAYCLOSURE_LIVE',
            'TM_LAYER_TEMPORARYSPEEDLIMIT_LIVE',
            'TM_LAYER_WEIGHTRESTRICTION_LIVE',
            'TM_LAYER_SUSPENSIONWEIGHTRESTRICTION_LIVE',
            'TM_LAYER_CLEARWAY_LIVE',
            'TM_LAYER_TOWAWAYZONE_LIVE',
            'TM_LAYER_TEMPPARKINGRESTRICTION_LIVE',
            'TM_LAYER_SUSPENSIONPARKINGRESTRICTION_LIVE',
            'TM_LAYER_SUSPENSION_BUSWAY_LIVE',
            'TM_LAYER_SUSPENSION_BUSWAY_TRIAL',
            'TM_LAYER_GRITTING_LIVE',
            'TM_LAYER_PREFERRED_ACCESS_V7_LIVE',
            'TM_LAYER_CLOSURE_CROSSING_LIVE',
            'TM_LAYER_ROADAHEADCLOSED_LIVE',
            'TM_LAYER_NOVEHICLEACCESS_LIVE',
            'TM_LAYER_NORIGHTTURN_LIVE',
            'TM_LAYER_NOLEFTTURN_LIVE',
            'TM_LAYER_NOUTURN_LIVE',
            'TM_LAYER_SUSPENSIONONEWAY_LIVE',
            'TM_LAYER_REVERSALONEWAY_LIVE',
            'TM_LAYER_TWOWAYSIGNALS_LIVE',
            'TM_LAYER_MULTIWAYSIGNALS_LIVE',
            'TM_LAYER_STOPANDGO_LIVE',
            'TM_LAYER_GIVEANDTAKE_LIVE',
            'TM_LAYER_PRIORITYSIGNS_LIVE',
            'TM_LAYER_CONVOYWORKING_LIVE',
            'TM_LAYER_WORKSSTOP_LIVE',
            'ROADWORKS_CURRENT',
            'TM_LAYER_ENTITY_CYCLING_LIVE',
            'TM_LAYER_ENTITY_FOOTBALL_LIVE',
            'TM_LAYER_ENTITY_HORSE_RACING_LIVE',
            'TM_LAYER_ENTITY_MOTOR_SPORT_EVENT_LIVE',
            'TM_LAYER_ENTITY_RUGBY_LIVE',
            'TM_LAYER_ENTITY_RUNNING_LIVE',
            'TM_LAYER_ENTITY_SPORT_EVENT_LIVE',
            'TM_LAYER_ENTITY_CARNIVAL_PARADE_STREET_LIVE',
            'TM_LAYER_ENTITY_POLLING_STATION_LIVE',
            'TM_LAYER_ENTITY_AGRICULTURAL_SHOW_LIVE',
            'TM_LAYER_ENTITY_AIR_SHOW_LIVE',
            'TM_LAYER_ENTITY_REMEMBRANCE_PARADE_LIVE',
            'TM_LAYER_ENTITY_CHRISTMAS_EVENT_LIVE',
            'TM_LAYER_ENTITY_ENTERTAINMENT_EVENT_LIVE',
            'TM_LAYER_ENTITY_FESTIVAL_LIVE',
            'TM_LAYER_ENTITY_MARKET_LIVE',
            'TM_LAYER_ENTITY_FUNERAL_LIVE',
            'TM_LAYER_ENTITY_OTHER_PUBLIC_EVENTS_LIVE',
          ],
        },
        embedID: 'NGIZHOPRC0',
        ui: {
          breakingNewsWidget: 660,
        },
        system: {
          delayedLoad: true,
        },
        layer: {
          hideLayers: ['TM_LAYER_ENTITY_CRUISE_SHIP_LIVE'],
        },
        map: {
          swLat: 52.83978188528856,
          swLng: -3.142559340451953,
          neLat: 53.493445532391156,
          neLng: -1.5852473287332032,
        },
        dateRange: 'today',
      };

      const { createApp } = Vue;
      const app = createApp({
        data() {
          return {
            dateStart: undefined,
            dateEnd: undefined,
            start: undefined,
            end: undefined,
            backup: [],
            copyItems: [],
            currentPageIndex: 0,
            date: '',
            error: false,
            idRegEx: /^[A-Z]{2}\d{2}.*$/,
            ignoreRegEx: /Diversion route scheduled|Dates to be confimed/gi,
            items: [],
            loading: false,
            mapId: '',
            mapUrl: '',
            pageBtns: [],
            pageCount: 0,
            pageIndex: 0,
            pageSize: 20,
            pages: [],
            remRegEx: /Roadworks \/ License - |\(Cheshire East Council\)/g,
            searchFields: ['description', 'responsible', 'locations'],
            searchTerm: '',
            searchedItems: [],
            filteredItems: [],
            showMainMap: false,
            showMyTable: true,
            table: true,
            time: '',
            totalCount: 0,
            timeOptions: {
              hour: 'numeric',
              minute: '2-digit',
              hour12: true,
            },
            fields: [
              {
                id: 'locations',
                display: 'Location',
                sort: this.sortStr,
              },
              {
                id: 'description',
                display: 'Description',
                sort: this.sortStr,
              },
              { id: 'startDate', display: 'Start date', sort: this.sortNum },
              { id: 'endDate', display: 'End date', sort: this.sortNum },
              {
                id: 'responsible',
                display: 'Responsibility',
                sort: this.sortStr,
              },
            ],
          };
        },
        methods: {
          formatTime: function (t) {
            let time = t.toLocaleTimeString('en-GB', this.timeOptions);
            if (time === '12:00 pm') {
              return ' 12 noon';
            } else if (time.startsWith('0')) {
              time = '12' + time.slice(1);
            }
            return ' ' + time.replace(' ', '').toLowerCase();
          },
          toggleTabs: function () {
            this.showMainMap = !this.showMainMap;
            this.showMyTable = !this.showMyTable;
            if (this.showMainMap) {
              this.$nextTick(() => {
                let Elgin = { loader: { load: __ElginLoaderRetroFit } };
                Elgin.loader.load(OPTS);
              });
            }
          },
          showTable: function () {
            this.table = true;
            this.mapUrl = '';
          },
          showMap: function (item) {
            this.mapId = item.locations.split('^#')[0];
            this.mapUrl = `https://portal-gb.one.network/prd-portal-one-network/embed/?${
              item.url.split('?')[1]
            }&src=rw.org&options={"googleAPIKey"%3A"AIzaSyDG00gQi_7ApZ54lG6mOu6ov-fNLl7lpOg"%2C"organisationID"%3A1451%2C"embedded"%3Atrue}`;
            this.table = false;
          },
          formatDate: function (d) {
            return d.toLocaleDateString('en-GB');
          },
          setUpHeaders: function (e) {
            e.elem.addEventListener('keydown', (ev) => {
              if (ev.code === 'Enter') {
                this.sortByField(e);
              }
            });
          },
          sortNum: function (f) {
            return (a, b) => {
              return a[f] - b[f];
            };
          },
          sortStr: function (field) {
            return (a, b) => {
              let x = a[field].toLowerCase();
              let y = b[field].toLowerCase();
              if (x < y) {
                return -1;
              }
              if (x > y) {
                return 1;
              }
              return 0;
            };
          },
          sortByField: function (e) {
            this.resetIcons();
            let temp = [...this.items];
            temp.sort(e.sort(e.id));
            if (temp.some((e, i) => e.index !== this.items[i].index)) {
              this.items = [...temp];
              document.getElementById(`up${e.id}`).style.color = 'Black';
            } else {
              this.items = [...temp].reverse();
              document.getElementById(`down${e.id}`).style.color = 'Black';
            }
          },
          stripDesc: function (obj) {
            let temp = obj.description
              .replace(this.remRegEx, '')
              .replace(this.idRegEx, '')
              .split('^#')
              .filter((e) => !e.includes('scheduled'));
            return { ...obj, description: temp.join('^#') };
          },
          resetSearch: function () {
            this.searchTerm = '';
            this.search();
          },
          addIndex: function (arr) {
            arr.forEach((e, i) => (e.index = i));
          },
          calculatePages: function () {
            this.totalCount = this.searchedItems.length;
            this.pageCount = Math.ceil(this.totalCount / this.pageSize);
            this.pageIndex = 0;
            this.pageBtns = Array.from(
              { length: this.pageCount },
              (_, i) => i + 1,
            );
            this.createPages();
            this.items = this.pages[0];
          },
          reset: function () {
            this.setPickers();
            this.filteredItems = this.copyItems.slice();
            this.search();
          },
          createPages: function () {
            this.pages = [
              ...Array(Math.ceil(this.searchedItems.length / this.pageSize)),
            ].map(() => this.searchedItems.splice(0, this.pageSize));
          },
          goToPage: function (i) {
            document.getElementById('app').scrollIntoView();
            this.pageIndex = i;
            this.items = this.pages[i];
          },
          search: function () {
            this.searchedItems =
              this.searchTerm === ''
                ? this.filteredItems.slice()
                : this.filteredItems.filter((item) =>
                    this.searchFields.some((term) =>
                      item[term]
                        .toLowerCase()
                        .includes(this.searchTerm.toLowerCase()),
                    ),
                  );
            this.calculatePages();
          },
          resetIcons: function () {
            this.fields.forEach((obj) => {
              document.getElementById(`up${obj.id}`).style.color = 'gray';
              document.getElementById(`down${obj.id}`).style.color = 'gray';
            });
          },
          addDates: function (arr) {
            return arr.map((e) => {
              e.startDate = new Date(e.startDate);
              e.endDate = new Date(e.endDate);
              return e;
            });
          },
          getUTCDate(date) {
            return Date.UTC(
              date.getUTCFullYear(),
              date.getUTCMonth(),
              date.getUTCDate(),
              date.getUTCHours(),
              date.getUTCMinutes(),
              date.getUTCSeconds(),
            );
          },
          filter: function () {
            let st = this.getUTCDate( new Date(`${this.dateStart}T00:00`));
            let end = this.getUTCDate(new Date(`${this.dateEnd}T23:59:59`));
            this.filteredItems = this.copyItems.filter(
              (e) => this.getUTCDate(e.startDate) >= st && this.getUTCDate(e.endDate) <= end,
            );
            this.search();
          },
          setPickers: function () {
            this.dateStart = this.start.toLocaleDateString('en-CA');
            this.dateEnd = this.end.toLocaleDateString('en-CA');
          },
          getData: function () {
            this.loading = true;
            fetch('/table')
              .then((res) => {
                console.log(res);
                if (!res.ok) {
                  throw 'No data.';
                }
                return res.json();
              })
              .then((data) => {
                let temp = new Date(data.date);
                this.date = temp.toLocaleDateString('en-GB');
                this.time = this.formatTime(temp);
                this.copyItems = this.addDates(data.items).filter(
                  (e) => !e.description.match(this.ignoreRegEx),
                );
                this.copyItems = this.copyItems.map((e) => this.stripDesc(e));
                this.addIndex(this.copyItems);
                this.copyItems.sort(this.sortNum('startDate'));
                this.searchedItems = [...this.copyItems];
                this.filteredItems = [...this.copyItems];
                this.calculatePages();
                this.loading = false;
                this.start = this.items[0].startDate;
                this.end = this.items.reduce((acc, item) => {
                  return item.endDate > acc ? item.endDate : acc;
                }, 0);
                this.start.setHours(0, 0, 0, 0);
                this.end.setHours(23, 59, 59, 999);
                this.setPickers();
              })
              .catch((err) => {
                this.loading = false;
                this.error = true;
              });
          },
        },
        mounted() {
          this.getData();
          this.fields.forEach((e) => {
            e.elem = document.getElementById(e.id);
            this.setUpHeaders(e);
          });
          this.mapTab = document.getElementById('map-tab');
        },
      }).mount('#app');
    </script>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
  </body>
</html>
